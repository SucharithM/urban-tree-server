generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model TreeNode {
  id           String  @id @default(uuid())
  nodeId       String  @unique
  boardId      String?
  name         String?
  location     String?
  sensorDepths String?
  sitePi       String?
  lat          Float?
  lon          Float?
  species      String?
  dbh          Float? // Diameter at Breast Height (mm)

  // Calibration parameters for dendrometer
  dendroSlope  Float? // raw/mm conversion
  dendroOffset Float? // raw offset
  initialDbh   Float? // Initial DBH (mm)

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rawReadings      RawReading[]
  computedReadings ComputedReading[]

  @@index([nodeId])
  @@map("tree_nodes")
}

model RawReading {
  id          String   @id @default(uuid())
  treeNodeId  String
  timestamp   DateTime // We are preserving the timestamp from the sensor for easy debug/lookup
  temperature Float?
  pressure    Float?
  humidity    Float?
  dendrometer Float?
  sapflow1    Float? //10mm depth
  sapflow2    Float? //20mm depth
  sapflow3    Float? //35mm depth
  sapflow4    Float? //50mm depth
  battery     Float?
  lipoCharge  Float?
  notes       String?
  dataSource  String? // "rawData", "archive", or specific sheet name uploaded by the researcher
  importedAt  DateTime @default(now())

  // Relations
  treeNode        TreeNode         @relation(fields: [treeNodeId], references: [id], onDelete: Cascade)
  computedReading ComputedReading?

  @@unique([treeNodeId, timestamp]) // Prevent duplicates
  @@index([treeNodeId, timestamp])
  @@index([timestamp])
  @@map("raw_readings")
}

model ComputedReading {
  id                 String      @id @default(uuid())
  treeNodeId         String
  timestamp          DateTime
  dendroCalibratedMm Float?
  sapflowCmPerHr     Float?
  sfMaxD             Float?
  sfSignal           Float?
  sfNoise            Float?
  rawReadingId       String?     @unique
  rawReading         RawReading? @relation(fields: [rawReadingId], references: [id], onDelete: SetNull)
  dataSource         String?
  importedAt         DateTime    @default(now())

  // Relations
  treeNode TreeNode @relation(fields: [treeNodeId], references: [id], onDelete: Cascade)

  @@unique([treeNodeId, timestamp]) // Prevent duplicates
  @@index([treeNodeId, timestamp])
  @@index([timestamp])
  @@map("computed_readings")
}

model ImportJob {
  id              String       @id @default(uuid())
  fileName        String
  fileSize        Int
  sheetsProcessed String[] // ["nodeInfo", "rawData", "archive"]
  status          ImportStatus @default(PENDING)

  // Statistics
  recordsImported Int @default(0)
  recordsSkipped  Int @default(0)
  recordsFailed   Int @default(0)

  // Error/warning logs
  warnings Json[] @default([])
  errors   Json[] @default([])

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([status])
  @@index([startedAt])
  @@map("import_jobs")
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  role         Role     @default(VIEWER)
  createdAt    DateTime @default(now())
}

enum Role {
  ADMIN
  VIEWER
}
