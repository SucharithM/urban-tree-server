# Urban Tree Server

RESTful API that ingests IoT workbook exports, normalizes raw sensor data for urban trees, and serves curated views for downstream dashboards. Built with Express + TypeScript, Supabase for storage, and deployed as a Netlify Function.

## Features

- Tree catalog endpoints with optional latest-reading enrichment and detail views.
- Raw, processed, and aggregated reading feeds (latest, windowed, processed, summarized buckets).
- XLSX import pipeline that upserts tree metadata and readings (raw + computed) with chunked retries.
- JWT-based authentication with cookie or Bearer token support; admin gate on imports.
- Swagger UI at `/docs` (backed by OpenAPI 3 via `swagger-jsdoc`).
- Health and DB connectivity probes for orchestration and monitoring.

## Architecture

- **Entry points:** `src/index.ts` loads env vars and starts Express; `src/app.ts` wires middleware (JSON, cookies, CORS), health/db probes, Swagger UI, and mounts routers under `BASE_PATH` (set for Netlify).
- **Routers/controllers:**
  - `routes/auth.routes.ts` → `controllers/auth.controller.ts` for login/logout.
  - `routes/import.routes.ts` → `controllers/import.controller.ts` for XLSX upload and job lookup.
  - `routes/trees.routes.ts` → `controllers/trees.controller.ts` for tree lists, detail, raw/processed/latest readings, and summaries.
- **Services:** Thin data layer over Supabase:
  - `services/trees/tree.service.ts` fetches tree metadata plus latest reading.
  - `services/readings/rawReading.service.ts`, `processedReading.service.ts`, `summaryReading.service.ts` serve different reading views and aggregation.
  - `services/import/importer.service.ts` + `excel.service.ts` parse workbooks (nodeInfo/rawData/archive + processed sheets), upsert trees (`tree_nodes`), raw readings (`raw_readings`), computed readings (`computed_readings`), and track jobs (`import_jobs`).
  - `services/auth/auth.service.ts` + `services/user/user.service.ts` validate users (`User` table) and mint JWTs.
- **Auth middleware:** `middleware/auth.middleware.ts` extracts JWT from header or cookie, verifies with `AUTH_JWT_SECRET`, and enforces admin role for protected routes.
- **Serverless adapter:** `netlify/functions/server.ts` wraps the Express app via `serverless-http`; `netlify.toml` maps `/api/*` and `/docs/*` to the function.

## API surface

- `GET /api/health` – service heartbeat.
- `GET /api/dbcheck` – Supabase connectivity check.
- `POST /api/auth/login` / `POST /api/auth/logout`.
- `GET /api/trees` – filters: `active`, `search`, `limit`, `offset`, `withLatest`.
- `GET /api/trees/:id` – tree detail + latest reading.
- `GET /api/trees/:id/readings` – raw readings with `from`, `to`, `source`, `limit`, `order`.
- `GET /api/trees/:id/readings/latest` – most recent raw reading.
- `GET /api/trees/:id/readings/processed` – computed readings or raw fallback with `from`, `to`, `limit`, `order`.
- `GET /api/trees/:id/readings/summary` – hourly/daily/all buckets with `from`, `to`, `source`, `bucketSize`, `limit`.
- `POST /api/imports/upload` – multipart field `file`; admin-only; XLSX ingestion.
- `GET /api/imports` and `GET /api/imports/:id` – import job history and lookup.

See live OpenAPI docs at `/docs`.

## XLSX import format

- Sheet `nodeInfo` (optional) describes nodes (`Node`, `Board_ID`, `Name`, `Location`, `Sensor Depths`, `Site PI`, `Lat`, `Lon`, `Species`, `DBH`).
- Sheets `rawData` and `archive` hold raw readings with `Node`, `Timestamp`, and metric columns (temperature, pressure, humidity, dendrometer, sapflow1-4, battery, LiPo Charge, Notes). Parsed rows map to `raw_readings`.
- Additional processed sheets (per-node, e.g., generated by Professor) are detected automatically and populate `computed_readings` (calibrated dendro, sapflow, etc.).
- Import jobs are chunked (500 rows) with retries and stored in `import_jobs` for auditability.

## Local development

1. `npm install`
2. Create `.env` with required secrets (see below).
3. `npm run dev` (watches `src/**/*.ts` via `tsx`) or `npm run build && npm start` for the compiled server.
4. Open `http://localhost:<PORT>/docs` for Swagger after the server starts.

### Environment variables

- `PORT` – port for local Express server.
- `BASE_PATH` – optional base path prefix.
- `SERVER_URL` – host for Swagger when `API_BASE_URL` is not set.
- `API_BASE_URL` – explicit API base URL.
- `SUPABASE_URL` – Supabase project URL.
- `SUPABASE_SERVICE_ROLE_KEY` – service role key for database access.
- `AUTH_JWT_SECRET` – secret for signing JWTs.
- `AUTH_JWT_EXPIRES_IN` – JWT TTL (default `24h`).

## Scripts

- `npm run dev` – watch mode.
- `npm test` – Node test runner (no tests included yet).
- `npm run lint` / `npm run lint:fix`
- `npm run format` / `npm run format:fix`
- `npm run typecheck`
- `npm run build` and `npm start`

## Directory layout

- `src/app.ts` – Express wiring, middleware, docs, health checks.
- `src/routes` / `src/controllers` – route definitions and request handlers.
- `src/services` – Supabase access for auth, trees, readings, imports, Excel parsing.
- `src/config` – Supabase and auth setup, Swagger definition.
- `netlify/` – serverless adapter and redirects config.
- `dist/` – build output.

## Deployment notes

- Netlify builds via `npm run build`; `netlify.toml` proxies `/api/*` and `/docs/*` to the serverless function at `/.netlify/functions/server`.
- Ensure Netlify environment variables mirror local `.env` values.
